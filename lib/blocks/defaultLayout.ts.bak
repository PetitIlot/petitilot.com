/**
 * Génère un layout par défaut à partir des données d'une activité existante
 * Utilisé pour les activités qui n'ont pas encore de content_blocks
 */

import { RessourceWithCreator } from '@/lib/supabase-queries'
import {
  ContentBlock,
  ContentBlocksData,
  DEFAULT_CANVAS_CONFIG,
  createBlock,
  TitleBlockData,
  ImageBlockData,
  CreatorBlockData,
  TextBlockData,
  ListBlockData,
  ListLinksBlockData,
  PurchaseBlockData,
  TipBlockData,
  VideoBlockData
} from './types'

/**
 * Génère un ContentBlocksData par défaut basé sur les données de l'activité
 */
export function generateDefaultLayout(activity: RessourceWithCreator): ContentBlocksData {
  const blocks: ContentBlock[] = []
  let currentY = 0
  const spacing = 24 // Espacement entre les blocs

  // 1. Hero Image (si disponible)
  if (activity.images_urls && activity.images_urls.length > 0) {
    blocks.push(createBlock(
      'image',
      {
        imageIndex: 0,
        objectFit: 'cover',
        showOverlay: false
      } as ImageBlockData,
      { x: 0, y: currentY, width: 100, height: 300, zIndex: 1 },
      { borderRadius: 16, padding: 0 }
    ))
    currentY += 300 + spacing
  }

  // 2. Bloc Titre
  blocks.push(createBlock(
    'title',
    {
      showBadges: true,
      showThemes: true,
      showCompetences: true,
      titleSize: 'lg',
      alignment: 'left'
    } as TitleBlockData,
    { x: 0, y: currentY, width: 100, height: 'auto', zIndex: 10 },
    { padding: 0 }
  ))
  currentY += 180 + spacing // Estimation de la hauteur du titre

  // 3. Bloc Créateur
  if (activity.creator) {
    blocks.push(createBlock(
      'creator',
      {
        variant: 'full',
        showFollowButton: true,
        showStats: true
      } as CreatorBlockData,
      { x: 0, y: currentY, width: 100, height: 'auto', zIndex: 5 },
      { padding: 0 }
    ))
    currentY += 100 + spacing
  }

  // 4. Description (texte)
  if (activity.description) {
    blocks.push(createBlock(
      'text',
      {
        content: activity.description,
        fontSize: 'md',
        fontWeight: 'normal',
        alignment: 'left'
      } as TextBlockData,
      { x: 0, y: currentY, width: 100, height: 'auto', zIndex: 1 },
      { padding: 0 }
    ))
    currentY += 120 + spacing
  }

  // 5. Galerie (si plus d'une image)
  if (activity.gallery_urls && activity.gallery_urls.length > 0) {
    blocks.push(createBlock(
      'carousel',
      {
        showDots: true,
        showArrows: true,
        autoPlay: false,
        interval: 3000
      },
      { x: 0, y: currentY, width: 100, height: 300, zIndex: 1 },
      { borderRadius: 12 }
    ))
    currentY += 300 + spacing
  }

  // 6. Liste du matériel
  const materiels = activity.materiel_json || []
  if (materiels.length > 0) {
    blocks.push(createBlock(
      'list',
      {
        title: 'Matériel nécessaire',
        sourceField: 'materiel_json',
        showRecupBadge: true,
        bulletStyle: 'dot',
        columns: 1
      } as ListBlockData,
      { x: 0, y: currentY, width: 100, height: 'auto', zIndex: 1 },
      { backgroundPreset: 'surface', borderRadius: 16, padding: 24, border: true }
    ))
    currentY += 150 + spacing

    // 7. Liens d'achat (si des liens existent)
    const hasLinks = materiels.some(mat => mat.url)
    if (hasLinks) {
      blocks.push(createBlock(
        'list-links',
        {
          title: 'Où acheter',
          sourceField: 'materiel_json',
          showAffiliateNote: true
        } as ListLinksBlockData,
        { x: 0, y: currentY, width: 100, height: 'auto', zIndex: 1 },
        { backgroundPreset: 'surface', borderRadius: 16, padding: 24, border: true }
      ))
      currentY += 150 + spacing
    }
  }

  // 8. Astuces
  if (activity.astuces) {
    blocks.push(createBlock(
      'tip',
      {
        icon: 'lightbulb',
        accentColor: 'sage'
      } as TipBlockData,
      { x: 0, y: currentY, width: 100, height: 'auto', zIndex: 1 },
      { padding: 0 }
    ))
    currentY += 100 + spacing
  }

  // 9. Vidéo embed
  if (activity.video_url) {
    blocks.push(createBlock(
      'video',
      {
        platform: 'auto',
        aspectRatio: activity.video_url.includes('instagram') ? '4:5' : '16:9'
      } as VideoBlockData,
      { x: 0, y: currentY, width: 100, height: 400, zIndex: 1 },
      { borderRadius: 12 }
    ))
    currentY += 400 + spacing
  }

  // 10. Bouton achat/téléchargement (toujours à la fin)
  if (activity.pdf_url) {
    blocks.push(createBlock(
      'purchase',
      {
        variant: 'full',
        showPrice: true
      } as PurchaseBlockData,
      { x: 0, y: currentY, width: 100, height: 'auto', zIndex: 20 },
      { padding: 0 }
    ))
  }

  return {
    version: 1,
    canvas: {
      ...DEFAULT_CANVAS_CONFIG,
      height: 'auto'
    },
    layout: {
      desktop: blocks
    },
    metadata: {
      templateName: 'auto-generated'
    }
  }
}

/**
 * Génère un layout vide pour commencer de zéro
 */
export function generateEmptyLayout(): ContentBlocksData {
  return {
    version: 1,
    canvas: {
      ...DEFAULT_CANVAS_CONFIG,
      height: 'auto'
    },
    layout: {
      desktop: []
    }
  }
}

/**
 * Presets de layouts prédéfinis que les créateurs peuvent choisir
 */
export const LAYOUT_PRESETS = {
  classic: 'Layout classique - Image hero, titre, description, matériel',
  recipe: 'Layout recette - Ingrédients à gauche, étapes à droite',
  gallery: 'Layout galerie - Focus sur les images avec carrousel large',
  minimal: 'Layout minimal - Titre, description, téléchargement',
  magazine: 'Layout magazine - Titre sur image, texte en colonnes'
} as const

export type LayoutPresetKey = keyof typeof LAYOUT_PRESETS
