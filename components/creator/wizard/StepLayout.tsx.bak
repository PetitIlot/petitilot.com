'use client'

import { useState, useMemo, useEffect } from 'react'
import { Layout, Plus, Eye, Wand2, Save, Trash2, X } from 'lucide-react'
import { Language } from '@/lib/types'
import { ResourceFormData } from '../ResourceWizard'
import {
  ContentBlocksData,
  generateDefaultLayout,
  generateEmptyLayout,
  ContentBlock,
  BlockType,
  BLOCK_PRESETS,
  createBlock,
  PRESET_TEMPLATES,
  PresetTemplateKey,
  SavedTemplate,
  getCreatorTemplates,
  createTemplate,
  deleteTemplate
} from '@/lib/blocks'
import { RessourceWithCreator } from '@/lib/supabase-queries'
import { BlockCanvas } from '@/components/blocks'
import {
  DndContext,
  closestCenter,
  KeyboardSensor,
  PointerSensor,
  useSensor,
  useSensors,
  DragEndEvent
} from '@dnd-kit/core'
import {
  arrayMove,
  SortableContext,
  sortableKeyboardCoordinates,
  verticalListSortingStrategy
} from '@dnd-kit/sortable'
import { Button } from '@/components/ui/button'
import DraggableBlock from '@/components/blocks/editor/DraggableBlock'

const translations = {
  fr: {
    title: 'Mise en page',
    description: 'Choisissez un template ou personnalisez la pr√©sentation de votre fiche.',
    chooseTemplate: 'Choisir un template',
    savedTemplates: 'Mes templates sauvegard√©s',
    orCustomize: 'ou personnalisez',
    generateDefault: 'G√©n√©rer auto',
    startEmpty: 'Vide',
    preview: 'Aper√ßu',
    edit: '√âditer',
    addBlock: 'Ajouter un bloc',
    noBlocks: 'Aucun bloc',
    noBlocksDesc: 'Choisissez un template ci-dessus ou ajoutez des blocs manuellement',
    currentTemplate: 'Template actuel',
    saveTemplate: 'Sauvegarder comme template',
    saveTemplateTitle: 'Sauvegarder ce layout',
    templateName: 'Nom du template',
    templateNamePlaceholder: 'Mon super template',
    templateDesc: 'Description (optionnel)',
    templateDescPlaceholder: 'Description du template...',
    templateIcon: 'Ic√¥ne',
    templateColor: 'Couleur',
    cancel: 'Annuler',
    save: 'Sauvegarder',
    saving: 'Sauvegarde...',
    saved: 'Template sauvegard√© !',
    deleteConfirm: 'Supprimer ce template ?',
    deleteBtn: 'Supprimer',
    uses: 'utilisations',
    blockTypes: {
      title: 'Titre',
      image: 'Image',
      carousel: 'Carrousel',
      creator: 'Cr√©ateur',
      text: 'Texte',
      list: 'Liste',
      'list-links': 'Liens',
      purchase: 'Achat',
      video: 'Vid√©o',
      tip: 'Astuce',
      separator: 'S√©parateur'
    }
  },
  en: {
    title: 'Layout',
    description: 'Choose a template or customize your resource page presentation.',
    chooseTemplate: 'Choose a template',
    savedTemplates: 'My saved templates',
    orCustomize: 'or customize',
    generateDefault: 'Auto-generate',
    startEmpty: 'Empty',
    preview: 'Preview',
    edit: 'Edit',
    addBlock: 'Add block',
    noBlocks: 'No blocks',
    noBlocksDesc: 'Choose a template above or add blocks manually',
    currentTemplate: 'Current template',
    saveTemplate: 'Save as template',
    saveTemplateTitle: 'Save this layout',
    templateName: 'Template name',
    templateNamePlaceholder: 'My awesome template',
    templateDesc: 'Description (optional)',
    templateDescPlaceholder: 'Template description...',
    templateIcon: 'Icon',
    templateColor: 'Color',
    cancel: 'Cancel',
    save: 'Save',
    saving: 'Saving...',
    saved: 'Template saved!',
    deleteConfirm: 'Delete this template?',
    deleteBtn: 'Delete',
    uses: 'uses',
    blockTypes: {
      title: 'Title',
      image: 'Image',
      carousel: 'Carousel',
      creator: 'Creator',
      text: 'Text',
      list: 'List',
      'list-links': 'Links',
      purchase: 'Purchase',
      video: 'Video',
      tip: 'Tip',
      separator: 'Separator'
    }
  },
  es: {
    title: 'Dise√±o',
    description: 'Elige una plantilla o personaliza la presentaci√≥n de tu recurso.',
    chooseTemplate: 'Elegir plantilla',
    savedTemplates: 'Mis plantillas guardadas',
    orCustomize: 'o personaliza',
    generateDefault: 'Generar auto',
    startEmpty: 'Vac√≠o',
    preview: 'Vista previa',
    edit: 'Editar',
    addBlock: 'A√±adir bloque',
    noBlocks: 'Sin bloques',
    noBlocksDesc: 'Elige una plantilla arriba o a√±ade bloques manualmente',
    currentTemplate: 'Plantilla actual',
    saveTemplate: 'Guardar como plantilla',
    saveTemplateTitle: 'Guardar este dise√±o',
    templateName: 'Nombre de la plantilla',
    templateNamePlaceholder: 'Mi plantilla genial',
    templateDesc: 'Descripci√≥n (opcional)',
    templateDescPlaceholder: 'Descripci√≥n de la plantilla...',
    templateIcon: 'Icono',
    templateColor: 'Color',
    cancel: 'Cancelar',
    save: 'Guardar',
    saving: 'Guardando...',
    saved: '¬°Plantilla guardada!',
    deleteConfirm: '¬øEliminar esta plantilla?',
    deleteBtn: 'Eliminar',
    uses: 'usos',
    blockTypes: {
      title: 'T√≠tulo',
      image: 'Imagen',
      carousel: 'Carrusel',
      creator: 'Creador',
      text: 'Texto',
      list: 'Lista',
      'list-links': 'Enlaces',
      purchase: 'Compra',
      video: 'V√≠deo',
      tip: 'Consejo',
      separator: 'Separador'
    }
  }
}

// Ic√¥nes disponibles pour les templates
const TEMPLATE_ICONS = ['üìê', 'üìÑ', 'üé®', '‚ú®', 'üåü', 'üí°', 'üéØ', 'üìù', 'üî•', 'üíé']

// Couleurs disponibles
const TEMPLATE_COLORS = [
  '#A8B5A0', // Sage
  '#D4A59A', // Terracotta
  '#5AC8FA', // Sky
  '#CCA6C8', // Mauve
  '#F4D03F', // Yellow
  '#E74C3C', // Red
  '#3498DB', // Blue
  '#2ECC71'  // Green
]

interface StepLayoutProps {
  formData: ResourceFormData
  updateFormData: (updates: Partial<ResourceFormData>) => void
  lang: Language
  creatorId: string
}

export default function StepLayout({ formData, updateFormData, lang, creatorId }: StepLayoutProps) {
  const t = translations[lang]
  const [isPreview, setIsPreview] = useState(false)
  const [selectedBlockId, setSelectedBlockId] = useState<string | null>(null)
  const [showBlockPicker, setShowBlockPicker] = useState(false)

  // Saved templates state
  const [savedTemplates, setSavedTemplates] = useState<SavedTemplate[]>([])
  const [loadingSaved, setLoadingSaved] = useState(true)

  // Save modal state
  const [showSaveModal, setShowSaveModal] = useState(false)
  const [saveForm, setSaveForm] = useState({
    name: '',
    description: '',
    icon: 'üìê',
    color: '#A8B5A0'
  })
  const [isSaving, setIsSaving] = useState(false)
  const [saveSuccess, setSaveSuccess] = useState(false)

  // Delete confirmation
  const [deleteConfirmId, setDeleteConfirmId] = useState<string | null>(null)

  // Load saved templates on mount
  useEffect(() => {
    async function loadTemplates() {
      setLoadingSaved(true)
      const templates = await getCreatorTemplates(creatorId)
      setSavedTemplates(templates)
      setLoadingSaved(false)
    }
    loadTemplates()
  }, [creatorId])

  // Cr√©er une activit√© "mock" √† partir des donn√©es du formulaire pour le rendu des blocs
  const mockActivity: RessourceWithCreator = useMemo(() => ({
    id: 'preview',
    creator_id: creatorId,
    group_id: 'preview',
    slug: 'preview',
    lang: lang,
    type: 'activite',
    title: formData.title || 'Titre de la ressource',
    subtitle: formData.subtitle || null,
    description: formData.description || '',
    astuces: formData.astuces || null,
    age_min: formData.age_min,
    age_max: formData.age_max,
    duration: formData.duration,
    duration_max: null,
    duration_prep: formData.duration_prep,
    intensity: formData.intensity,
    difficulte: formData.difficulte,
    autonomie: formData.autonomie,
    categories: formData.categories,
    themes: formData.themes,
    competences: formData.competences,
    keywords: formData.keywords,
    materials: formData.materials,
    materiel_json: formData.materiel_json,
    vignette_url: formData.vignette_url || null,
    images_urls: formData.images_urls,
    gallery_urls: formData.gallery_urls,
    video_url: formData.video_url || null,
    pdf_url: formData.pdf_url || null,
    price_credits: formData.price_credits,
    is_premium: formData.price_credits > 0,
    is_published: false,
    view_count: 0,
    download_count: 0,
    status: 'draft',
    created_at: new Date().toISOString(),
    updated_at: new Date().toISOString(),
    published_at: null,
    meta_seo: null,
    creator: {
      id: creatorId,
      slug: 'preview-creator',
      display_name: 'Vous',
      bio: null,
      avatar_url: null,
      banner_url: null,
      website: null,
      social_links: null,
      is_verified: false,
      stripe_account_id: null,
      stripe_onboarding_complete: false,
      follower_count: 0,
      ressource_count: 0,
      created_at: new Date().toISOString(),
      updated_at: new Date().toISOString()
    }
  }), [formData, creatorId, lang])

  // Parser/initialiser content_blocks
  const blocksData: ContentBlocksData = useMemo(() => {
    if (formData.content_blocks) {
      return formData.content_blocks as ContentBlocksData
    }
    return generateEmptyLayout()
  }, [formData.content_blocks])

  const blocks = blocksData.layout.desktop

  // Sensors pour drag & drop
  const sensors = useSensors(
    useSensor(PointerSensor, {
      activationConstraint: { distance: 8 },
    }),
    useSensor(KeyboardSensor, {
      coordinateGetter: sortableKeyboardCoordinates,
    })
  )

  // Mettre √† jour les blocs
  const updateBlocks = (newBlocks: ContentBlock[]) => {
    const newData: ContentBlocksData = {
      ...blocksData,
      layout: {
        ...blocksData.layout,
        desktop: newBlocks
      }
    }
    updateFormData({ content_blocks: newData })
  }

  // G√©n√©rer layout par d√©faut
  const handleGenerateDefault = () => {
    const defaultLayout = generateDefaultLayout(mockActivity)
    updateFormData({ content_blocks: defaultLayout })
  }

  // Commencer vide
  const handleStartEmpty = () => {
    updateFormData({ content_blocks: generateEmptyLayout() })
  }

  // Gestion drag & drop
  const handleDragEnd = (event: DragEndEvent) => {
    const { active, over } = event
    if (over && active.id !== over.id) {
      const oldIndex = blocks.findIndex((b) => b.id === active.id)
      const newIndex = blocks.findIndex((b) => b.id === over.id)
      updateBlocks(arrayMove(blocks, oldIndex, newIndex))
    }
  }

  // Ajouter un bloc
  const handleAddBlock = (type: BlockType) => {
    const preset = BLOCK_PRESETS[type]
    const newBlock = createBlock(
      type,
      preset.data!,
      preset.position,
      preset.style
    )
    updateBlocks([...blocks, newBlock])
    setSelectedBlockId(newBlock.id)
    setShowBlockPicker(false)
  }

  // Actions sur les blocs
  const handleDeleteBlock = (blockId: string) => {
    updateBlocks(blocks.filter(b => b.id !== blockId))
    if (selectedBlockId === blockId) setSelectedBlockId(null)
  }

  const handleDuplicateBlock = (blockId: string) => {
    const block = blocks.find(b => b.id === blockId)
    if (!block) return
    const blockIndex = blocks.findIndex(b => b.id === blockId)
    const newBlock: ContentBlock = { ...block, id: crypto.randomUUID() }
    const newBlocks = [...blocks]
    newBlocks.splice(blockIndex + 1, 0, newBlock)
    updateBlocks(newBlocks)
  }

  const handleToggleVisibility = (blockId: string) => {
    updateBlocks(blocks.map(b =>
      b.id === blockId ? { ...b, visible: b.visible === false ? true : false } : b
    ))
  }

  const handleToggleLock = (blockId: string) => {
    updateBlocks(blocks.map(b =>
      b.id === blockId ? { ...b, locked: !b.locked } : b
    ))
  }

  const blockTypes: BlockType[] = ['title', 'image', 'carousel', 'creator', 'text', 'list', 'list-links', 'purchase', 'video', 'tip', 'separator']

  // Appliquer un template pr√©d√©fini
  const handleApplyTemplate = (templateKey: PresetTemplateKey) => {
    const template = PRESET_TEMPLATES[templateKey]
    const newLayout = template.create()
    updateFormData({ content_blocks: newLayout })
  }

  // Appliquer un template sauvegard√©
  const handleApplySavedTemplate = (template: SavedTemplate) => {
    updateFormData({ content_blocks: template.template_data })
  }

  // Sauvegarder le layout actuel comme template
  const handleSaveTemplate = async () => {
    if (!saveForm.name.trim() || blocks.length === 0) return

    setIsSaving(true)
    const result = await createTemplate(creatorId, {
      name: saveForm.name.trim(),
      description: saveForm.description.trim() || undefined,
      icon: saveForm.icon,
      color: saveForm.color,
      template_data: blocksData
    })

    if (result) {
      setSavedTemplates([result, ...savedTemplates])
      setSaveSuccess(true)
      setTimeout(() => {
        setShowSaveModal(false)
        setSaveSuccess(false)
        setSaveForm({ name: '', description: '', icon: 'üìê', color: '#A8B5A0' })
      }, 1500)
    }
    setIsSaving(false)
  }

  // Supprimer un template sauvegard√©
  const handleDeleteTemplate = async (templateId: string) => {
    const success = await deleteTemplate(templateId)
    if (success) {
      setSavedTemplates(savedTemplates.filter(t => t.id !== templateId))
    }
    setDeleteConfirmId(null)
  }

  // Obtenir le nom du template actuel
  const currentTemplateName = blocksData.metadata?.templateName

  return (
    <div className="space-y-6">
      {/* Header */}
      <div>
        <h3 className="text-lg font-semibold text-[#5D5A4E] flex items-center gap-2">
          <Layout className="w-5 h-5 text-[#A8B5A0]" />
          {t.title}
        </h3>
        <p className="text-sm text-[#5D5A4E]/70 mt-1">{t.description}</p>
      </div>

      {/* Template Selector - Preset Templates */}
      <div>
        <p className="text-sm font-medium text-[#5D5A4E] mb-3">{t.chooseTemplate}</p>
        <div className="grid grid-cols-2 gap-3">
          {Object.entries(PRESET_TEMPLATES).map(([key, template]) => (
            <button
              key={key}
              onClick={() => handleApplyTemplate(key as PresetTemplateKey)}
              className={`
                relative p-4 rounded-xl text-left transition-all
                ${currentTemplateName === key
                  ? 'ring-2 ring-offset-2'
                  : 'hover:scale-[1.02] hover:shadow-md'
                }
              `}
              style={{
                backgroundColor: `${template.color}15`,
                borderColor: template.color,
                border: '1px solid',
                ...(currentTemplateName === key && { ringColor: template.color })
              }}
            >
              <div className="flex items-start gap-3">
                <span className="text-2xl">{template.icon}</span>
                <div className="flex-1 min-w-0">
                  <p className="font-semibold text-[#5D5A4E]">
                    {template.name[lang]}
                  </p>
                  <p className="text-xs text-[#5D5A4E]/70 mt-0.5 line-clamp-2">
                    {template.description[lang]}
                  </p>
                </div>
              </div>
              {currentTemplateName === key && (
                <div
                  className="absolute top-2 right-2 w-5 h-5 rounded-full flex items-center justify-center text-white text-xs"
                  style={{ backgroundColor: template.color }}
                >
                  ‚úì
                </div>
              )}
            </button>
          ))}
        </div>
      </div>

      {/* Saved Templates */}
      {(savedTemplates.length > 0 || loadingSaved) && (
        <div>
          <p className="text-sm font-medium text-[#5D5A4E] mb-3">{t.savedTemplates}</p>
          {loadingSaved ? (
            <div className="text-sm text-[#5D5A4E]/50 py-4 text-center">
              Chargement...
            </div>
          ) : (
            <div className="grid grid-cols-2 gap-3">
              {savedTemplates.map((template) => (
                <div
                  key={template.id}
                  className="relative group"
                >
                  <button
                    onClick={() => handleApplySavedTemplate(template)}
                    className="w-full p-4 rounded-xl text-left transition-all hover:scale-[1.02] hover:shadow-md"
                    style={{
                      backgroundColor: `${template.color}15`,
                      borderColor: template.color,
                      border: '1px solid'
                    }}
                  >
                    <div className="flex items-start gap-3">
                      <span className="text-2xl">{template.icon}</span>
                      <div className="flex-1 min-w-0">
                        <p className="font-semibold text-[#5D5A4E]">
                          {template.name}
                        </p>
                        {template.description && (
                          <p className="text-xs text-[#5D5A4E]/70 mt-0.5 line-clamp-2">
                            {template.description}
                          </p>
                        )}
                        <p className="text-xs text-[#5D5A4E]/50 mt-1">
                          {template.use_count} {t.uses}
                        </p>
                      </div>
                    </div>
                  </button>

                  {/* Delete button */}
                  {deleteConfirmId === template.id ? (
                    <div className="absolute inset-0 bg-white/95 rounded-xl flex items-center justify-center gap-2 p-2">
                      <span className="text-xs text-[#5D5A4E]">{t.deleteConfirm}</span>
                      <Button
                        size="sm"
                        variant="destructive"
                        onClick={() => handleDeleteTemplate(template.id)}
                      >
                        {t.deleteBtn}
                      </Button>
                      <Button
                        size="sm"
                        variant="ghost"
                        onClick={() => setDeleteConfirmId(null)}
                      >
                        {t.cancel}
                      </Button>
                    </div>
                  ) : (
                    <button
                      onClick={() => setDeleteConfirmId(template.id)}
                      className="absolute top-2 right-2 w-6 h-6 rounded-full bg-white/80 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity hover:bg-red-100"
                    >
                      <Trash2 className="w-3 h-3 text-red-500" />
                    </button>
                  )}
                </div>
              ))}
            </div>
          )}
        </div>
      )}

      {/* Divider */}
      <div className="flex items-center gap-3">
        <div className="flex-1 h-px bg-border" />
        <span className="text-xs text-foreground-secondary uppercase">{t.orCustomize}</span>
        <div className="flex-1 h-px bg-border" />
      </div>

      {/* Actions */}
      <div className="flex items-center gap-2 flex-wrap">
        <Button
          variant="outline"
          size="sm"
          onClick={handleGenerateDefault}
          className="border-sage text-sage hover:bg-sage/10"
        >
          <Wand2 className="w-4 h-4 mr-2" />
          {t.generateDefault}
        </Button>

        <Button
          variant="outline"
          size="sm"
          onClick={handleStartEmpty}
        >
          {t.startEmpty}
        </Button>

        {blocks.length > 0 && (
          <Button
            variant="outline"
            size="sm"
            onClick={() => setShowSaveModal(true)}
            className="border-[#5AC8FA] text-[#5AC8FA] hover:bg-[#5AC8FA]/10"
          >
            <Save className="w-4 h-4 mr-2" />
            {t.saveTemplate}
          </Button>
        )}

        <div className="flex-1" />

        <Button
          variant={isPreview ? 'default' : 'outline'}
          size="sm"
          onClick={() => setIsPreview(!isPreview)}
        >
          {isPreview ? t.edit : t.preview}
          <Eye className="w-4 h-4 ml-2" />
        </Button>
      </div>

      {/* Block picker dropdown */}
      {!isPreview && (
        <div className="relative">
          <Button
            variant="outline"
            size="sm"
            onClick={() => setShowBlockPicker(!showBlockPicker)}
            className="w-full justify-center border-dashed border-2"
          >
            <Plus className="w-4 h-4 mr-2" />
            {t.addBlock}
          </Button>

          {showBlockPicker && (
            <div className="absolute top-full left-0 right-0 mt-2 bg-white rounded-xl shadow-lg border border-border z-50 p-2 grid grid-cols-3 gap-1">
              {blockTypes.map((type) => (
                <button
                  key={type}
                  onClick={() => handleAddBlock(type)}
                  className="px-3 py-2 text-sm text-left hover:bg-sage/10 rounded-lg transition-colors"
                >
                  {t.blockTypes[type]}
                </button>
              ))}
            </div>
          )}
        </div>
      )}

      {/* Canvas */}
      <div
        className="bg-surface-secondary rounded-xl overflow-hidden min-h-[400px]"
        style={{ border: '1px solid var(--border)' }}
      >
        {blocks.length === 0 ? (
          <div className="flex flex-col items-center justify-center h-[400px] text-foreground-secondary">
            <Layout className="w-12 h-12 mb-4 opacity-30" />
            <p className="text-lg font-medium">{t.noBlocks}</p>
            <p className="text-sm mt-1">{t.noBlocksDesc}</p>
          </div>
        ) : isPreview ? (
          <div className="p-4">
            <BlockCanvas
              blocksData={blocksData}
              activity={mockActivity}
              lang={lang}
              isEditing={false}
            />
          </div>
        ) : (
          <div className="p-4">
            <DndContext
              sensors={sensors}
              collisionDetection={closestCenter}
              onDragEnd={handleDragEnd}
            >
              <SortableContext
                items={blocks.map(b => b.id)}
                strategy={verticalListSortingStrategy}
              >
                <div className="space-y-2 pt-8">
                  {blocks.map((block) => (
                    <DraggableBlock
                      key={block.id}
                      block={block}
                      activity={mockActivity}
                      lang={lang}
                      isSelected={selectedBlockId === block.id}
                      onSelect={() => setSelectedBlockId(block.id)}
                      onDelete={() => handleDeleteBlock(block.id)}
                      onDuplicate={() => handleDuplicateBlock(block.id)}
                      onToggleVisibility={() => handleToggleVisibility(block.id)}
                      onToggleLock={() => handleToggleLock(block.id)}
                    />
                  ))}
                </div>
              </SortableContext>
            </DndContext>
          </div>
        )}
      </div>

      {/* Info */}
      <p className="text-xs text-foreground-secondary text-center">
        {blocks.length} bloc{blocks.length > 1 ? 's' : ''} ‚Ä¢ Glissez-d√©posez pour r√©organiser
      </p>

      {/* Save Template Modal */}
      {showSaveModal && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-2xl shadow-xl max-w-md w-full p-6 space-y-4">
            <div className="flex items-center justify-between">
              <h3 className="text-lg font-semibold text-[#5D5A4E]">
                {t.saveTemplateTitle}
              </h3>
              <button
                onClick={() => setShowSaveModal(false)}
                className="p-1 hover:bg-gray-100 rounded-lg"
              >
                <X className="w-5 h-5" />
              </button>
            </div>

            {saveSuccess ? (
              <div className="py-8 text-center">
                <div className="text-4xl mb-2">‚úÖ</div>
                <p className="text-lg font-medium text-[#A8B5A0]">{t.saved}</p>
              </div>
            ) : (
              <>
                {/* Name */}
                <div>
                  <label className="block text-sm font-medium text-[#5D5A4E] mb-1">
                    {t.templateName} *
                  </label>
                  <input
                    type="text"
                    value={saveForm.name}
                    onChange={(e) => setSaveForm({ ...saveForm, name: e.target.value })}
                    placeholder={t.templateNamePlaceholder}
                    className="w-full px-3 py-2 border border-border rounded-lg focus:outline-none focus:ring-2 focus:ring-sage"
                  />
                </div>

                {/* Description */}
                <div>
                  <label className="block text-sm font-medium text-[#5D5A4E] mb-1">
                    {t.templateDesc}
                  </label>
                  <textarea
                    value={saveForm.description}
                    onChange={(e) => setSaveForm({ ...saveForm, description: e.target.value })}
                    placeholder={t.templateDescPlaceholder}
                    rows={2}
                    className="w-full px-3 py-2 border border-border rounded-lg focus:outline-none focus:ring-2 focus:ring-sage resize-none"
                  />
                </div>

                {/* Icon & Color */}
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-[#5D5A4E] mb-1">
                      {t.templateIcon}
                    </label>
                    <div className="flex flex-wrap gap-1">
                      {TEMPLATE_ICONS.map((icon) => (
                        <button
                          key={icon}
                          onClick={() => setSaveForm({ ...saveForm, icon })}
                          className={`w-8 h-8 rounded-lg flex items-center justify-center text-lg transition-all ${
                            saveForm.icon === icon
                              ? 'bg-sage/20 ring-2 ring-sage'
                              : 'hover:bg-gray-100'
                          }`}
                        >
                          {icon}
                        </button>
                      ))}
                    </div>
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-[#5D5A4E] mb-1">
                      {t.templateColor}
                    </label>
                    <div className="flex flex-wrap gap-1">
                      {TEMPLATE_COLORS.map((color) => (
                        <button
                          key={color}
                          onClick={() => setSaveForm({ ...saveForm, color })}
                          className={`w-8 h-8 rounded-lg transition-all ${
                            saveForm.color === color
                              ? 'ring-2 ring-offset-2 ring-gray-400'
                              : 'hover:scale-110'
                          }`}
                          style={{ backgroundColor: color }}
                        />
                      ))}
                    </div>
                  </div>
                </div>

                {/* Actions */}
                <div className="flex justify-end gap-2 pt-2">
                  <Button
                    variant="ghost"
                    onClick={() => setShowSaveModal(false)}
                  >
                    {t.cancel}
                  </Button>
                  <Button
                    onClick={handleSaveTemplate}
                    disabled={!saveForm.name.trim() || isSaving}
                    className="bg-sage hover:bg-sage/90"
                  >
                    {isSaving ? t.saving : t.save}
                  </Button>
                </div>
              </>
            )}
          </div>
        </div>
      )}
    </div>
  )
}
